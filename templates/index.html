<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeniusBI | Enterprise Analytics</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/dashboard.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Essential UI Overrides */
        :root {
            --bg-main: #f8fafc;
            --bg-sidebar: #0f172a;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --accent: #2563eb;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --border-radius: 12px;
            /* Header transparency variables */
            --header-bg: rgba(248, 250, 252, 0.8);
        }

        [data-theme='dark'] {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --accent: #38bdf8;
            --border: #334155;
            --header-bg: rgba(15, 23, 42, 0.8);
        }

        [data-theme='aesthetic'] {
            --bg-main: #020617;
            --bg-card: #0f172a;
            --text-main: #e2e8f0;
            --accent: #10b981;
            --border: #1e293b;
            --header-bg: rgba(2, 6, 23, 0.8);
        }

        body { background-color: var(--bg-main); color: var(--text-main); transition: background 0.3s ease; font-family: 'Inter', sans-serif; margin: 0; }
        .glass-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--border-radius); padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        .nav-links li { transition: 0.2s; color: rgba(255,255,255,0.7); list-style: none; }
        .nav-links li.active { background: rgba(255,255,255,0.1); color: var(--accent) !important; font-weight: 600; }
        .nav-links li:hover { background: rgba(255,255,255,0.05); color: white; }

        .history-section { display: flex; flex-direction: column; height: 100%; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        #history-list { list-style: none; padding: 0; overflow-y: auto; max-height: 250px; }
        .history-item { padding: 8px; border-radius: 6px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.8rem;}
        .history-item:hover { background: rgba(255,255,255,0.05); }
        
        .theme-dropdown { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; outline: none; }
        
        .pivot-workspace-layout { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; }
        .hidden { display: none !important; }

        .log-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .log-table th { background: var(--bg-main); padding: 12px; text-align: left; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border); }
        .log-table td { padding: 12px; border-bottom: 1px solid var(--border); }

        .btn-sync {
            background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }

        .btn-delete {
            background: #fee2e2;
            color: var(--danger);
            border: 1px solid #fecaca;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: 0.2s;
        }
        .btn-delete:hover {
            background: var(--danger);
            color: white;
        }
        
        .chart-selector-group optgroup { color: var(--accent); font-weight: bold; font-style: normal; }

        /* --- NAVBAR FIXES --- */
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 100; /* Stays above content */
            background: var(--header-bg); /* Use semi-transparent background */
            backdrop-filter: blur(12px); /* Frost effect */
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 15px 40px; /* Aligned with main padding */
            margin-bottom: 25px !important; /* Spacing from content */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body data-theme="light">

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loader-content" style="text-align: center;">
            <div class="dna-spinner"></div>
            <h3 style="margin-top: 20px;">GeniusBI AI Processing...</h3>
            <p style="color: #94a3b8;">Mining data patterns and optimizing visual engine.</p>
        </div>
    </div>

    <div class="app-container" style="display: flex; min-height: 100vh;">
        <aside class="sidebar" style="width: 280px; background: var(--bg-sidebar); color: white; padding: 30px 20px; display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh; overflow: hidden; z-index: 110;">
            <div class="logo" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 40px; letter-spacing: -1px;">
                Aura<span style="color: #38bdf8;">Analytics</span>
            </div>
            
            <ul class="nav-links" style="list-style: none; padding: 0; flex-grow: 1;">
                <li onclick="switchView('import', this)" class="active" style="padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; display: flex; gap: 10px; align-items: center;">
                    <span>üì•</span> Import Data
                </li>
                <li onclick="switchView('dashboard', this)" style="padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; display: flex; gap: 10px; align-items: center;">
                    <span>üìä</span> BI Dashboard
                </li>
                <li onclick="switchView('pivot', this)" style="padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; display: flex; gap: 10px; align-items: center;">
                    <span>üßÆ</span> Pivot Workspace
                </li>
                <li onclick="switchView('logs', this)" style="padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; display: flex; gap: 10px; align-items: center;">
                    <span>üìú</span> Data Logs
                </li>
                <li onclick="switchView('settings', this)" style="padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; display: flex; gap: 10px; align-items: center;">
                    <span>‚öôÔ∏è</span> Settings
                </li>
            </ul>

            <div class="history-section">
                <h4 style="font-size: 0.7rem; color: #94a3b8; letter-spacing: 1px; margin-bottom: 15px;">RECENT SESSIONS</h4>
                <ul id="history-list"></ul>
                <button onclick="localStorage.removeItem('genius_bi_history'); location.reload();" style="background: none; border: none; color: #ef4444; font-size: 0.75rem; cursor: pointer; margin-top: 10px; text-align: left; padding: 0;">
                    üóëÔ∏è Clear History
                </button>
            </div>
        </aside>

        <main class="main-content" style="flex-grow: 1; background: var(--bg-main); display: flex; flex-direction: column;">
            <header class="top-bar">
                <h1 id="view-title" style="font-size: 1.5rem; font-weight: 700; margin: 0;">Import Data</h1> 
                <div class="header-actions" style="display: flex; align-items: center; gap: 20px;">
                    <select id="themeSelect" class="theme-dropdown">
                        <option value="light">‚òÄÔ∏è Light</option>
                        <option value="dark">üåô Dark</option>
                        <option value="aesthetic">üé® Aesthetic Pro</option>
                    </select>

                    <div class="profile-tag" style="display: flex; align-items: center; gap: 10px; background: var(--bg-card); padding: 5px 15px; border-radius: 30px; border: 1px solid var(--border);">
                        <span style="font-weight: 600; font-size: 0.85rem;">BI Analyst</span>
                        <div style="width: 28px; height: 28px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">A</div>
                    </div>
                </div>
            </header>

            <div class="view-wrapper" style="padding: 0 40px 40px 40px;">
                <section id="import" class="view">
                    <div class="upload-container glass-card" style="max-width: 600px; margin: 40px auto; text-align: center;">
                        <h2 style="margin-bottom: 10px;">Intelligence Entry</h2>
                        <p style="color: #64748b; margin-bottom: 30px;">Drop CSV or Excel files for instant data processing.</p>
                        
                        <div class="drop-zone" id="dropZone" style="border: 2px dashed var(--border); padding: 60px; border-radius: 12px; cursor: pointer; margin-bottom: 20px;">
                            <input type="file" id="filePicker" accept=".csv, .xlsx" hidden>
                            <span style="font-size: 3rem;">üìÇ</span>
                            <p id="fileLabel" style="margin-top: 15px; font-weight: 500;">Click to Browse Files</p>
                            <p id="fileNameDisplay" style="color: var(--accent); font-weight: bold; margin-top: 10px;"></p>
                        </div>
                        
                        <button id="uploadBtn" style="width: 100%; background: var(--accent); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            üöÄ Run BI Analysis
                        </button>
                    </div>
                </section>

                <section id="dashboard" class="view hidden">
                    <div id="dashboard-content-to-export">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h2 style="margin: 0;">Analytics Command Center</h2>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="pushDataToMySQL()" class="btn-sync">
                                    üóÑÔ∏è Sync to MySQL
                                </button>
                                <button id="pdfExportBtn" class="theme-dropdown" style="background: var(--accent); color: white; border: none;">
                                    üìÑ Export PDF
                                </button>
                            </div>
                        </div>

                        <div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px;">
                            <div class="glass-card">
                                <span style="color: #64748b; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Analyzed Rows</span>
                                <p id="stat-rows" style="font-size: 1.5rem; font-weight: 700; margin: 5px 0; color: var(--accent);">0</p>
                            </div>
                            <div class="glass-card">
                                <span style="color: #64748b; font-size: 0.75rem; text-transform: uppercase;">Schema Width</span>
                                <p id="stat-cols" style="font-size: 1.5rem; font-weight: 700; margin: 5px 0; color: var(--success);">0</p>
                            </div>
                            <div class="glass-card">
                                <span style="color: #64748b; font-size: 0.75rem; text-transform: uppercase;">Data Health</span>
                                <p id="stat-health" style="font-size: 1.5rem; font-weight: 700; margin: 5px 0; color: #f59e0b;">100%</p>
                            </div>
                            <div class="glass-card" style="padding: 15px; display: flex; align-items: center; justify-content: center;">
                                <canvas id="progressChart" width="80" height="80"></canvas>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px;">
                            <div class="glass-card">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                                    <select id="chartTypeSelect" class="theme-dropdown chart-selector-group" style="min-width: 220px;">
                                        <optgroup label="Comparison">
                                            <option value="bar">Bar Chart</option>
                                            <option value="column">Column Chart</option>
                                        </optgroup>
                                        <optgroup label="Trends">
                                            <option value="line">Line Chart</option>
                                            <option value="area">Area Trend</option>
                                        </optgroup>
                                        <optgroup label="Composition">
                                            <option value="pie">Pie Chart</option>
                                            <option value="donut">Donut Chart</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div style="height: 400px; position: relative;">
                                    <canvas id="mainAnalyticsChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="glass-card">
                                <h3 style="font-size: 1rem; margin-top: 0;">‚ú¶ AI Insight Stream</h3>
                                <ul id="ai-insights-list" style="list-style: none; padding: 0; margin-top: 20px;">
                                    <li style="color: #94a3b8; font-size: 0.85rem;">Ready for analysis...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="logs" class="view hidden">
                    <div class="glass-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h3>MySQL Data Repository</h3>
                            <button onclick="fetchDatabaseLogs()" class="btn-sync" style="background: var(--accent);">üîÑ Sync Database</button>
                        </div>
                        <div id="logs-table-container" style="max-height: 600px; overflow-y: auto;">
                            <p style="text-align: center; color: #94a3b8; padding: 40px;">No records synced yet.</p>
                        </div>
                    </div>
                </section>

                <section id="pivot" class="view hidden">
                    <div class="pivot-workspace-layout">
                        <div class="glass-card">
                            <h3>Pivot Configuration</h3>
                            <div style="margin-top: 25px;">
                                <label style="font-size: 0.75rem; font-weight: 700; color: #94a3b8;">ROWS (Dimension)</label>
                                <select id="pivot-row-select" class="theme-dropdown" style="width: 100%; margin: 8px 0 20px 0;" onchange="generatePivot()"></select>
                                
                                <label style="font-size: 0.75rem; font-weight: 700; color: #94a3b8;">VALUES (Measure)</label>
                                <select id="pivot-val-select" class="theme-dropdown" style="width: 100%; margin: 8px 0 20px 0;" onchange="generatePivot()"></select>
                                
                                <label style="font-size: 0.75rem; font-weight: 700; color: #94a3b8;">AGGREGATION</label>
                                <select id="pivot-agg" class="theme-dropdown" style="width: 100%; margin: 8px 0 20px 0;" onchange="generatePivot()">
                                    <option value="sum">Sum</option>
                                    <option value="mean">Average</option>
                                    <option value="count">Count</option>
                                    <option value="min">Min</option>
                                    <option value="max">Max</option>
                                </select>
                                <button id="excelBtn" onclick="downloadPivotExcel()" style="width: 100%; background: var(--success); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 700;">üì• Excel Download</button>
                            </div>
                        </div>
                        <div class="glass-card" id="pivot-table-output" style="overflow-x: auto; min-height: 400px;">
                            <p style="text-align: center; color: #94a3b8; padding-top: 150px;">Select fields to build your table.</p>
                        </div>
                    </div>
                </section>

                <section id="settings" class="view hidden">
                    <div class="glass-card" style="max-width: 600px;">
                        <h3>Interface Settings</h3>
                        <div style="margin-top: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border);">
                                <span>Global Chart Palette</span>
                                <select id="chartColorSelect" class="theme-dropdown" style="min-width: 180px;">
                                    <option value="default">üîµ Genius Blue</option>
                                    <option value="emerald">üü¢ Emerald Forest</option>
                                    <option value="sunset">üü† Sunset Orange</option>
                                    <option value="royal">üü£ Royal Purple</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </section>
            </div> 
        </main>
    </div>

    <script src="static/js/chart_bi.js"></script>
    <script src="static/js/pivot.js"></script>
    <script src="static/js/main.js"></script>

    <script>
        /* Essential Dropzone Logic */
        const dropZone = document.getElementById('dropZone');
        const filePicker = document.getElementById('filePicker');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const fileLabel = document.getElementById('fileLabel');

        if(dropZone) {
            dropZone.addEventListener('click', () => filePicker.click());
            filePicker.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    fileLabel.innerText = "Target Selected:";
                    fileNameDisplay.innerText = e.target.files[0].name;
                }
            });
        }

        /* PDF EXPORT HANDLER */
        document.getElementById('pdfExportBtn').addEventListener('click', async function() {
            const { jsPDF } = window.jspdf;
            const container = document.getElementById('dashboard-content-to-export');
            const btn = this;
            
            btn.innerHTML = "‚åõ Exporting...";
            btn.disabled = true;

            try {
                const canvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-main').trim() || "#f8fafc"
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('l', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`GeniusBI_Report_${new Date().getTime()}.pdf`);
            } catch (err) {
                console.error("PDF Error:", err);
                alert("Could not generate PDF. Check console.");
            } finally {
                btn.innerHTML = "üìÑ Export PDF";
                btn.disabled = false;
            }
        });

        async function deleteLog(logId) {
            if (!confirm('Are you sure?')) return;
            try {
                const response = await fetch(`/api/delete_log/${logId}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.status === 'success') fetchDatabaseLogs();
            } catch (err) {
                console.error('Delete failed:', err);
            }
        }
    </script>
</body>
</html>